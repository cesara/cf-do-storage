<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>CF Worker and Durable Object Storage Tests</title>
  </head>
  <body>
    <h1>CF Worker and DO Storage Tests</h1>
    <div>
      <p>
        This page demonstrates that a Cloudflare durable-object's storage
        sustained writes will cause a reset.
      </p>
    </div>
    <div>
      <input type="button" value="Run Test" onclick="testDoWebSocket();" />
      <input type="button" value="Cancel Test" onclick="cancelAlarm();" />
    </div>
    <h2>Log (new messages are prepended)</h2>
    <pre id="log"></pre>
    <textarea id="textLog" rows="40" cols="200" readonly></textarea>

    <script>
      const textLog = document.getElementById("textLog"); // Add this line

      function log(...msgParts) {
        const newMessage = msgParts.join(" ") + "\n";
        let currentLogContent = textLog.value.split("\n"); 
        currentLogContent.unshift(newMessage); 
        if (currentLogContent.length > 2000) {
          currentLogContent = currentLogContent.slice(0, 2000); 
        }
        textLog.value = currentLogContent.join("\n"); 
      }
      
      let ws;

      function createRequestBody(i, pageTimestamp) {
        return JSON.stringify({ i, pageTimestamp });
      }


      function testDoWebSocket() {
        const url = new URL(location.href);
        url.protocol = url.protocol === "https:" ? "wss:" : "ws:";
        url.pathname = `/do-websocket`;
        ws = new WebSocket(url.toString());
        ws.addEventListener("message", async (e) => {
          if (e.data === "ping") {
            log(e.data);
          } else if (typeof e.data === "string") {
            log(e.data);
          }
        });


    }

    function cancelAlarm() {
    if (ws) {
      //send message to websocket
      ws.send("cancelAlarm");
    }
  }
    

      
    </script>
  </body>
</html>
