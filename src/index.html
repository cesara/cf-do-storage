<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <script>
      globalThis.roomIDReady = new Promise((resolve) => {
        globalThis.resolveRoomID = resolve;
      });
    </script>
    <title>CF Worker and Durable Object Storage Tests</title>

    <script type="module">
      import { nanoid } from "https://cdnjs.cloudflare.com/ajax/libs/nanoid/5.0.7/index.browser.js";
      globalThis.roomID = nanoid();
      globalThis.resolveRoomID();
    </script>
  </head>
  <body>
    <h1>CF Worker and DO Storage Tests</h1>
    <div>
      <p>
        This page demonstrates that a Cloudflare durable-object's storage
        sustained writes will cause a reset.
      </p>
    </div>
    <div>
      <label for="keySize">Number of Keys:</label>
      <input
        type="number"
        id="keySize"
        value="100"
        onchange="updateQueryParams('keySize', this.value)"
      />
      <label for="nextAlarm">Next Alarm (ms):</label>
      <input
        type="number"
        id="nextAlarm"
        value="86"
        onchange="updateQueryParams('nextAlarm', this.value)"
      />
      <label for="roomIDInput">RoomID:</label>
      <input type="text" id="roomIDInput" readonly />
      <input type="button" value="Run Test" onclick="testDoWebSocket();" />
      <input type="button" value="Cancel Test" onclick="cancelAlarm();" />
    </div>
    <h2>Log (new messages are prepended)</h2>
    <pre id="log"></pre>
    <textarea id="textLog" rows="40" cols="200" readonly></textarea>
    <script>
      function updateQueryParams(param, value) {
        const url = new URL(window.location.href);
        url.searchParams.set(param, value);
        window.history.pushState({}, "", url);
      }

      function getQueryParam(param, defaultValue) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param) || defaultValue;
      }

      document.getElementById("keySize").value = getQueryParam(
        "keySize",
        "100"
      );
      document.getElementById("nextAlarm").value = getQueryParam(
        "nextAlarm",
        "86"
      );
      globalThis.roomIDReady.then(() => {
        document.getElementById("roomIDInput").value = globalThis.roomID;
      });

      const textLog = document.getElementById("textLog"); // Add this line

      function log(...msgParts) {
        textLog.value = `${msgParts.join(" ")}\n${textLog.value}`;
        const lines = textLog.value.split("\n");
        if (lines.length > 2000)
          textLog.value = lines.slice(0, 2000).join("\n");
      }

      let ws;

      function testDoWebSocket() {
        const wsUrl = new URL(location.href);
        wsUrl.protocol = wsUrl.protocol === "https:" ? "wss:" : "ws:";
        wsUrl.pathname = "/do-websocket";
        ["keySize", "nextAlarm"].forEach((param) =>
          wsUrl.searchParams.set(param, getQueryParam(param, "100"))
        );
        wsUrl.searchParams.set("roomID", globalThis.roomID);

        ws = new WebSocket(wsUrl.toString());
        ws.addEventListener("message", async (e) => {
          if (e.data === "ping") {
            log(e.data);
          } else if (typeof e.data === "string") {
            log(e.data);
          }
        });
      }

      function cancelAlarm() {
        if (ws) {
          ws.send("cancelAlarm");
        }
      }
    </script>
  </body>
</html>
